/*
  Script:  Create and Populate NDB_TeamTransactionRulesMapping
  Purpose: Map every Team/TransactionType to its set of Rules
*/

-- 1. Drop existing table if it exists
IF OBJECT_ID('dbo.NDB_TeamTransactionRulesMapping', 'U') IS NOT NULL
    DROP TABLE dbo.NDB_TeamTransactionRulesMapping;
GO

-- 2. Create the mapping table
CREATE TABLE dbo.NDB_TeamTransactionRulesMapping
(
    NDB_TeamId             INT         NOT NULL,
    NDB_TransactionTypeId  INT         NOT NULL,
    NDB_RuleId             INT         NOT NULL,
    CONSTRAINT PK_NDB_TTRM
        PRIMARY KEY CLUSTERED (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId),
    CONSTRAINT FK_NDB_TTRM_Teams
        FOREIGN KEY (NDB_TeamId) REFERENCES dbo.NDB_Teams(Id),
    CONSTRAINT FK_NDB_TTRM_Types
        FOREIGN KEY (NDB_TransactionTypeId) REFERENCES dbo.NDB_TransactionTypes(Id),
    CONSTRAINT FK_NDB_TTRM_Rules
        FOREIGN KEY (NDB_RuleId) REFERENCES dbo.NDB_Rules(Id)
);
GO

-- 3. Populate with INSERT â€¦ SELECT
-- 3.1 Team = Delegated, TransactionType = Demographic
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT 
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Demographic'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '47','48','2','50','4','51','6','52','10','53','13','54','14','55','18','20',
        '59','21','66','23','75','28','78','29','79','30','81','33','35','84','38',
        '86','39','89','91','43','93','46','94','96','98','99','102','103','105','106',
        '107','108','112','113','115','118','120'
    )
WHERE t.Team = 'Delegated';
GO

-- 3.2 Team = Delegated, TransactionType = Contractual
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT 
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Contractual'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '48','50','53','13','55','18','19','20','21','65','22','66','23','26','27',
        '28','78','29','79','30','33','84','38','86','39','89','40','91','43','93',
        '46','94','96','98','99','101','102','103','104','105','106','107','108',
        '110','112','113','114','115','116','117','118','119','120'
    )
WHERE t.Team = 'Delegated';
GO

-- 3.3 Team = Non-Delegated, TransactionType = Demographic
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Demographic'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '47','2','50','4','51','6','52','10','53','54','14','55','18','20','59',
        '21','66','23','75','28','78','29','30','81','33','83','35','38','86','39',
        '89','91','43','93','46','94','102','103','105','106','107','108','112',
        '113','118','120'
    )
WHERE t.Team = 'Non-Delegated';
GO

-- 3.4 Team = Non-Delegated, TransactionType = Contractual
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Contractual'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '50','53','55','18','19','20','21','65','22','66','23','26','69','27','28',
        '29','30','33','83','38','86','39','89','40','91','43','93','46','94','99',
        '101','102','103','104','105','106','107','108','110','112','113','114','117',
        '118','120'
    )
WHERE t.Team = 'Non-Delegated';
GO

-- 3.5 Team = PCRL-Fac/Anc, TransactionType = Demographic
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Demographic'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '4','10','56','57','20','23','67','28','78','29','30','81','35','89','91','108'
    )
WHERE t.Team = 'PCRL-Fac/Anc';
GO

-- 3.6 Team = PCRL-Fac/Anc, TransactionType = Contractual
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Contractual'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '56','20','65','23','67','28','78','29','30','89','40','91','104'
    )
WHERE t.Team = 'PCRL-Fac/Anc';
GO

-- 3.7 Team = marketCARES, TransactionType = Demographic
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Demographic'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '48','2','50','4','51','6','52','10','53','13','54','14','55','18','20',
        '59','66','23','75','28','78','29','79','30','81','33','83','35','84','38',
        '86','39','89','91','43','93','46','94','96','98','99','102','105','106',
        '107','108','112','113','115','118','120'
    )
WHERE t.Team = 'marketCARES';
GO

-- 3.8 Team = marketCARES, TransactionType = Contractual
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Contractual'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '48','2','50','4','51','10','53','13','55','18','19','20','59','65','22',
        '66','23','26','69','27','28','78','29','79','30','81','33','83','84','38',
        '86','39','89','40','91','43','46','94','96','98','99','101','102','103',
        '104','105','106','107','108','110','112','113','114','115','116','117','118',
        '119','120'
    )
WHERE t.Team = 'marketCARES';
GO

-- 3.9 Team = PCRL-FQHC/RHC, TransactionType = Demographic
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Demographic'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '48','2','50','4','51','10','53','54','55','56','57','20','22','23','67',
        '28','78','29','81','33','83','35','38','86','89','43','93','94','103','105',
        '108','112','118','120'
    )
WHERE t.Team = 'PCRL-FQHC/RHC';
GO

-- 3.10 Team = PCRL-FQHC/RHC, TransactionType = Contractual
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = 'Contractual'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '48','50','51','53','54','55','56','57','20','59','65','22','67','26','69',
        '27','28','78','29','33','83','38','86','39','89','40','43','93','94','103',
        '104','105','112','117','120'
    )
WHERE t.Team = 'PCRL-FQHC/RHC';
GO

-- 3.11 Team = CAQH, TransactionType = '-'
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = '-'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '50','10','53','14','55','18','59','66','27','78','33','83','35','38',
        '89','94','105','106','108'
    )
WHERE t.Team = 'CAQH';
GO

-- 3.12 Team = EPDL, TransactionType = '-'
INSERT INTO dbo.NDB_TeamTransactionRulesMapping (NDB_TeamId, NDB_TransactionTypeId, NDB_RuleId)
SELECT
    t.Id,
    tt.Id,
    r.Id
FROM dbo.NDB_Teams t
JOIN dbo.NDB_TransactionTypes tt
    ON tt.TransactionType = '-'
JOIN dbo.NDB_Rules r
    ON r.RuleName IN (
        '48','2','50','4','51','6','10','13','54','18','19','20','59','66','23',
        '78','30','81','33','35','38','40','43','93','103','104','105','106','108'
    )
WHERE t.Team = 'EPDL';
GO
